<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ComfyUI Web Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Collapsible Queue Sidebar -->
        <aside class="queue-sidebar" id="queueSidebar">
            <div class="queue-header">
                <h2>Queue <span id="queueCounter" class="queue-counter">0</span></h2>
                <div class="queue-header-actions">
                    <button class="btn-icon" id="unloadModelsBtn" title="Unload ComfyUI Models">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                    </button>
                    <button class="btn-icon" id="clearQueueBtn" title="Clear Queue">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                    <button class="toggle-queue" id="toggleQueue" title="Toggle Queue">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Auto-unload countdown timer -->
            <div class="auto-unload-timer" id="autoUnloadTimer" style="display: none;">
                <div class="timer-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <span id="timerText">Auto-unload in 5:00</span>
            </div>
            
            <div class="queue-content">
                <div class="queue-list" id="queueList">
                    <!-- Queued items will be displayed here -->
                </div>
                
                <div class="active-job" id="activeJob">
                    <!-- Active/generating job will be displayed here -->
                </div>
                
                <div class="completed-list" id="completedList">
                    <!-- Completed items will be displayed here -->
                </div>
                
                <div class="queue-empty" id="queueEmpty">
                    <p>Queue is empty</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="app-header">
                <button class="mobile-menu-btn" id="mobileMenuBtn" title="Toggle Menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1>ComfyUI Imaginer</h1>
            </header>

            <!-- Hardware Monitor -->
            <div class="hardware-monitor" id="hardwareMonitor">
                <div class="hw-stat">
                    <div class="hw-label">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                            <rect x="9" y="9" width="6" height="6"></rect>
                            <line x1="9" y1="1" x2="9" y2="4"></line>
                            <line x1="15" y1="1" x2="15" y2="4"></line>
                            <line x1="9" y1="20" x2="9" y2="23"></line>
                            <line x1="15" y1="20" x2="15" y2="23"></line>
                            <line x1="20" y1="9" x2="23" y2="9"></line>
                            <line x1="20" y1="14" x2="23" y2="14"></line>
                            <line x1="1" y1="9" x2="4" y2="9"></line>
                            <line x1="1" y1="14" x2="4" y2="14"></line>
                        </svg>
                        <span>CPU</span>
                    </div>
                    <div class="hw-bar">
                        <div class="hw-fill" id="cpuBar" style="width: 0%"></div>
                    </div>
                    <span class="hw-value" id="cpuValue">--%</span>
                </div>
                
                <div class="hw-stat">
                    <div class="hw-label">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                        </svg>
                        <span>RAM</span>
                    </div>
                    <div class="hw-bar">
                        <div class="hw-fill" id="ramBar" style="width: 0%"></div>
                    </div>
                    <span class="hw-value" id="ramValue">-- / -- GB</span>
                </div>
                
                <div class="hw-stat">
                    <div class="hw-label">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                            <path d="M12 8v8m-4-4h8"></path>
                        </svg>
                        <span>GPU</span>
                    </div>
                    <div class="hw-bar">
                        <div class="hw-fill" id="gpuBar" style="width: 0%"></div>
                    </div>
                    <span class="hw-value" id="gpuValue">--%</span>
                </div>
                
                <div class="hw-stat">
                    <div class="hw-label">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        </svg>
                        <span>VRAM</span>
                    </div>
                    <div class="hw-bar">
                        <div class="hw-fill" id="vramBar" style="width: 0%"></div>
                    </div>
                    <span class="hw-value" id="vramValue">-- / -- GB</span>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="single">Single</button>
                <button class="tab-btn" data-tab="batch">Text Batch</button>
                <button class="tab-btn" data-tab="image-batch">Image Batch</button>
                <button class="tab-btn" data-tab="browser">Browser</button>
                <button class="tab-btn" data-tab="reveal">Reveal Browser</button>
            </div>

            <div class="content-wrapper">
                <!-- Single Generation Tab -->
                <section class="tab-content active" id="singleTab">
                    <div class="generation-panel">
                        <!-- Image Upload Section -->
                        <div class="form-group">
                            <label for="imageUpload">Upload Image (Optional - for Image-to-Image)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input 
                                    type="file" 
                                    id="imageUpload" 
                                    accept="image/png,image/jpeg,image/jpg,image/webp,image/bmp"
                                    class="form-control"
                                    style="flex: 1;"
                                >
                                <button type="button" class="btn btn-sm" id="browseImageBtn" title="Browse Existing Images">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    Browse
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" id="clearImageBtn" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                    Clear
                                </button>
                            </div>
                            <div id="imagePreview" style="margin-top: 0.5rem; display: none;">
                                <img id="imagePreviewImg" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid var(--border);">
                            </div>
                        </div>

                        <!-- Use Image Size Option (only shown when image is uploaded) -->
                        <div class="form-group" id="useImageSizeGroup" style="display: none;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="useImageSize" class="checkbox-input">
                                <span>Use Uploaded Image Size</span>
                            </label>
                            <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                When enabled, width and height will match the uploaded image
                            </small>
                        </div>

                        <!-- Prompt -->
                        <div class="form-group">
                            <label for="prompt">Prompt</label>
                            <div class="prompt-container">
                                <textarea 
                                    id="prompt" 
                                    rows="4" 
                                    placeholder="Enter your prompt here... (Ctrl+Enter to generate)"
                                    class="form-control"
                                ></textarea>
                                <button class="btn btn-primary btn-generate" id="generateBtn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    <span>Generate</span>
                                </button>
                            </div>
                            <button class="btn btn-sm" id="editPromptWithAI" style="margin-top: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <span>✨ Edit with AI</span>
                            </button>
                        </div>

                        <!-- Basic Parameters -->
                        <button class="collapsible-header" data-target="singleParameters">
                            <span>Basic Parameters</span>
                            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="collapsible-content active" id="singleParameters">
                            <div class="parameters-grid">
                                <div class="form-group" id="widthGroup">
                                    <label for="width">Width</label>
                                    <input 
                                        type="number" 
                                        id="width" 
                                        value="512" 
                                        min="64" 
                                        max="2048" 
                                        step="64"
                                        class="form-control"
                                    >
                                </div>

                                <div class="form-group" id="heightGroup">
                                    <label for="height">Height</label>
                                    <input 
                                        type="number" 
                                        id="height" 
                                        value="1024" 
                                        min="64" 
                                        max="2048" 
                                        step="64"
                                        class="form-control"
                                    >
                                </div>

                                <div class="form-group">
                                    <label for="filePrefix">File Prefix (optional)</label>
                                    <input 
                                        type="text" 
                                        id="filePrefix" 
                                        placeholder="comfyui"
                                        class="form-control"
                                    >
                                </div>

                                <div class="form-group">
                                    <label for="subfolder">Output Folder (optional)</label>
                                    <input 
                                        type="text" 
                                        id="subfolder" 
                                        placeholder="Leave empty for root"
                                        class="form-control"
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Parameters -->
                        <button class="collapsible-header" data-target="advancedSettings">
                            <span>Advanced Settings</span>
                            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="collapsible-content" id="advancedSettings">
                            <div class="parameters-grid">
                                <div class="form-group">
                                    <label for="steps">Steps</label>
                                    <input 
                                        type="number" 
                                        id="steps" 
                                        value="4" 
                                        min="1" 
                                        max="100"
                                        class="form-control"
                                    >
                                </div>

                                <div class="form-group">
                                    <label for="cfg">CFG Scale</label>
                                    <input 
                                        type="number" 
                                        id="cfg" 
                                        value="1.0" 
                                        min="0.1" 
                                        max="20.0"
                                        step="0.1"
                                        class="form-control"
                                    >
                                </div>

                                <div class="form-group">
                                    <label for="shift">Shift</label>
                                    <input 
                                        type="number" 
                                        id="shift" 
                                        value="3.0" 
                                        min="0.0" 
                                        max="10.0"
                                        step="0.1"
                                        class="form-control"
                                    >
                                </div>

                                <div class="form-group">
                                    <label for="seed">Seed (optional)</label>
                                    <div class="input-with-clear">
                                        <input 
                                            type="number" 
                                            id="seed" 
                                            placeholder="Random"
                                            class="form-control"
                                        >
                                        <button type="button" class="clear-btn" id="clearSeedBtn" title="Clear seed">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LoRA Settings -->
                        <button class="collapsible-header" data-target="loraSettings">
                            <span>LoRA Settings</span>
                            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="collapsible-content" id="loraSettings">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="mcnlLora" class="checkbox-input">
                                    <span>MCNL LoRA (Female)</span>
                                </label>
                                <div class="keyword-list">
                                    <small>Keywords: cum_on_face, nsfw, blowjob, cowgirlout, creamp1e, penis</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="snofsLora" class="checkbox-input">
                                    <span>Snofs LoRA (Female)</span>
                                </label>
                                <div class="keyword-list">
                                    <small>Keywords: anus, blowjob, deepthroat, braless, cowgirl position, cum, cunnilingus, dildo, doggystyle position, fingering, hand in panties, handjob, implied blowjob, ipcam, masturbating, massage, missionary position, naked, nude, penis, prone position, reverse cowgirl position, sex, sheer, snapchat, selfie, mirror selfie, spooning position, strap-on dildo, tentacles, licking testicles, undressing, vagina</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="maleLora" class="checkbox-input">
                                    <span>Male LoRA</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Batch Generation Tab (Text Batch) -->
                <section class="tab-content" id="batchTab">
                    <div class="generation-panel">
                        <div class="batch-header" style="margin-bottom: 1.5rem;">
                            <h2 style="margin: 0 0 0.5rem 0;">Text Batch Generation</h2>
                            <p style="color: var(--text-muted); margin: 0; font-size: 0.95rem;">
                                Generate multiple images using a base prompt with parameters. Use [parameter] placeholders in your prompt and provide values via CSV.
                            </p>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="form-group">
                            <label for="batchImageUpload">Upload Image (Optional - for Image-to-Image)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input 
                                    type="file" 
                                    id="batchImageUpload" 
                                    accept="image/png,image/jpeg,image/jpg,image/webp,image/bmp"
                                    class="form-control"
                                    style="flex: 1;"
                                >
                                <button type="button" class="btn btn-sm" id="browseBatchImageBtn" title="Browse Existing Images">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    Browse
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" id="clearBatchImageBtn" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                    Clear
                                </button>
                            </div>
                            <div id="batchImagePreview" style="margin-top: 0.5rem; display: none;">
                                <img id="batchImagePreviewImg" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid var(--border);">
                            </div>
                        </div>

                        <!-- Use Image Size Option (only shown when image is uploaded) -->
                        <div class="form-group" id="batchUseImageSizeGroup" style="display: none;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="batchUseImageSize" class="checkbox-input">
                                <span>Use Uploaded Image Size</span>
                            </label>
                            <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                When enabled, width and height will match the uploaded image (ignores CSV width/height)
                            </small>
                        </div>

                        <!-- Base Prompt -->
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label for="batchBasePrompt">Base Prompt with Parameters</label>
                                <button class="btn btn-sm" id="editBatchPromptWithAI">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <span>✨ Edit with AI</span>
                                </button>
                            </div>
                            <textarea 
                                id="batchBasePrompt" 
                                rows="4" 
                                placeholder="Example: A photo of a [subject] in [setting], [lighting] lighting, [style] style"
                                class="form-control"
                            ></textarea>
                            <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Use [parameterName] to mark replaceable parameters. Detected parameters: <span id="detectedParameters" style="color: var(--primary); font-weight: 500;">None</span>
                            </small>
                        </div>

                        <!-- CSV Input -->
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label for="batchCSV">Parameter Values (CSV)</label>
                                <div class="csv-buttons-wrapper" style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm" id="generateCSVWithAI">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                        <span>✨ Generate CSV with AI</span>
                                    </button>
                                    <button class="btn btn-sm" id="editParameterValuesBtn">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        <span>✨ Edit Parameter Values</span>
                                    </button>
                                    <button class="btn btn-sm" id="loadCSVFile">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="17 8 12 3 7 8"></polyline>
                                            <line x1="12" y1="3" x2="12" y2="15"></line>
                                        </svg>
                                        <span>Load CSV File</span>
                                    </button>
                                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                                </div>
                            </div>
                            <textarea 
                                id="batchCSV" 
                                rows="8" 
                                placeholder="subject,setting,lighting,style&#10;woman,beach,golden hour,cinematic&#10;man,office,soft,professional&#10;cat,garden,natural,realistic"
                                class="form-control"
                                style="font-family: monospace; font-size: 0.9rem;"
                            ></textarea>
                            <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                First row: parameter names (must match [parameters] in prompt). Following rows: values for each image.
                            </small>
                        </div>

                        <!-- Preview -->
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label>Batch Preview</label>
                                <button class="btn btn-primary" id="queueBatchBtn" disabled>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    <span>Queue <span id="batchCount">0</span> Images</span>
                                </button>
                            </div>
                            <div id="batchPreview" class="batch-preview" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 1rem;">
                                <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                    Enter a base prompt with parameters and CSV data to preview the batch
                                </div>
                            </div>
                        </div>

                        <!-- Batch Parameters -->
                        <button class="collapsible-header" data-target="batchParameters">
                            <span>Parameters (Default or Per-Image via CSV)</span>
                            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="collapsible-content active" id="batchParameters">
                            <small style="color: var(--text-muted); display: block; margin-bottom: 1rem;">
                                Check "Use from CSV" to make a parameter vary per-image. Add a column in your CSV with the parameter name.
                            </small>
                            
                            <div class="parameters-grid">
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <label for="batchWidth">Width</label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchWidthVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                    <input type="number" id="batchWidth" value="1024" min="64" max="2048" step="64" class="form-control">
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <label for="batchHeight">Height</label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchHeightVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                    <input type="number" id="batchHeight" value="1024" min="64" max="2048" step="64" class="form-control">
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <label for="batchSteps">Steps</label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchStepsVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                    <input type="number" id="batchSteps" value="4" min="1" max="100" class="form-control">
                                </div>

                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <label for="batchCfg">CFG Scale</label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchCfgVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                    <input type="number" id="batchCfg" value="1.0" min="0.1" max="20.0" step="0.1" class="form-control">
                                </div>

                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <label for="batchShift">Shift</label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchShiftVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                    <input type="number" id="batchShift" value="3.0" min="0.0" max="10.0" step="0.1" class="form-control">
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <label for="batchSeed">Seed</label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchSeedVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                    <input type="number" id="batchSeed" placeholder="Random" class="form-control">
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <label for="batchFilePrefix">File Prefix</label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchFilePrefixVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                    <input type="text" id="batchFilePrefix" placeholder="batch" class="form-control">
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <label for="batchSubfolder">Output Folder</label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchSubfolderVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                    <input type="text" id="batchSubfolder" placeholder="Leave empty for root" class="form-control">
                                </div>
                            </div>

                            <button class="collapsible-header" data-target="batchLoraSettings">
                                <span>LoRA Settings</span>
                                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="collapsible-content active" id="batchLoraSettings">
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="batchMcnlLora" class="checkbox-input">
                                            <span>MCNL LoRA (Female)</span>
                                        </label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchMcnlLoraVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="batchSnofsLora" class="checkbox-input">
                                            <span>Snofs LoRA (Female)</span>
                                        </label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchSnofsLoraVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="batchMaleLora" class="checkbox-input">
                                            <span>Male LoRA</span>
                                        </label>
                                        <label class="checkbox-label" style="font-size: 0.85rem; margin: 0;">
                                            <input type="checkbox" id="batchMaleLoraVariable" class="checkbox-input batch-param-variable">
                                            <span>Use from CSV</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Image Batch Tab -->
                <section class="tab-content" id="imageBatchTab">
                    <div class="generation-panel">
                        <div class="batch-header" style="margin-bottom: 1.5rem;">
                            <h2 style="margin: 0 0 0.5rem 0;">Image Batch Generation</h2>
                            <p style="color: var(--text-muted); margin: 0; font-size: 0.95rem;">
                                Select a folder from the ComfyUI input directory. All images in that folder will be queued using the same prompt and settings. Image size is used automatically.
                            </p>
                        </div>

                        <!-- Prompt -->
                        <div class="form-group">
                            <label for="imageBatchPrompt">Prompt</label>
                            <div class="prompt-container">
                                <textarea 
                                    id="imageBatchPrompt" 
                                    rows="4" 
                                    placeholder="Enter your prompt for all images..."
                                    class="form-control"
                                ></textarea>
                                <button class="btn btn-primary" id="queueImageBatchBtn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    <span>Queue Image Batch</span>
                                </button>
                            </div>
                        </div>

                        <!-- Folder Selection -->
                        <div class="form-group">
                            <label>Input Folder</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button type="button" class="btn" id="chooseImageBatchFolderBtn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    Choose Folder
                                </button>
                                <span id="imageBatchFolderDisplay" style="color: var(--text-muted);">None selected</span>
                            </div>
                            <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                                Uses all image files directly under the selected folder.
                            </small>
                        </div>

                        <!-- Parameters (same as Single) -->
                        <button class="collapsible-header" data-target="imageBatchParameters">
                            <span>Parameters</span>
                            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="collapsible-content active" id="imageBatchParameters">
                            <div class="parameters-grid">
                                <div class="form-group">
                                    <label for="imageBatchSteps">Steps</label>
                                    <input type="number" id="imageBatchSteps" value="4" min="1" max="100" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="imageBatchCfg">CFG Scale</label>
                                    <input type="number" id="imageBatchCfg" value="1.0" min="0.1" max="20.0" step="0.1" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="imageBatchShift">Shift</label>
                                    <input type="number" id="imageBatchShift" value="3.0" min="0.0" max="10.0" step="0.1" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="imageBatchSeed">Seed (optional)</label>
                                    <input type="number" id="imageBatchSeed" placeholder="Random" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="imageBatchFilePrefix">File Prefix</label>
                                    <input type="text" id="imageBatchFilePrefix" placeholder="image_batch" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="imageBatchSubfolder">Output Folder</label>
                                    <input type="text" id="imageBatchSubfolder" placeholder="Leave empty for root" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- LoRA Settings -->
                        <button class="collapsible-header" data-target="imageBatchLoraSettings">
                            <span>LoRA Settings</span>
                            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="collapsible-content" id="imageBatchLoraSettings">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="imageBatchMcnlLora" class="checkbox-input">
                                    <span>MCNL LoRA (Female)</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="imageBatchSnofsLora" class="checkbox-input">
                                    <span>Snofs LoRA (Female)</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="imageBatchMaleLora" class="checkbox-input">
                                    <span>Male LoRA</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Image Browser Tab -->
                <section class="tab-content" id="browserTab">
                    <div class="gallery-panel">
                    <div class="gallery-header">
                        <h2>Image Browser</h2>
                        <div class="gallery-toolbar">
                            <button class="btn btn-sm" id="newFolderBtn" title="New Folder">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                    <line x1="12" y1="11" x2="12" y2="17"></line>
                                    <line x1="9" y1="14" x2="15" y2="14"></line>
                                </svg>
                                <span>Create Folder</span>
                            </button>
                            <button class="btn btn-sm" id="setOutputFolderBtn" title="Set as Output Folder">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span>Set Output Folder</span>
                            </button>
                            <button class="btn btn-sm" id="selectionModeBtn" title="Toggle Selection Mode">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 11l3 3L22 4"></path>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                </svg>
                                <span>Select</span>
                            </button>
                            <button class="btn btn-sm" id="moveBtn" title="Move Selected" style="display:none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="5 9 2 12 5 15"></polyline>
                                    <polyline points="9 5 12 2 15 5"></polyline>
                                    <polyline points="15 19 12 22 9 19"></polyline>
                                    <polyline points="19 9 22 12 19 15"></polyline>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <line x1="12" y1="2" x2="12" y2="22"></line>
                                </svg>
                                <span>Move Selected</span>
                            </button>
                            <button class="btn btn-sm btn-danger" id="deleteBtn" title="Delete Selected" style="display:none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                <span>Delete Selected</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="breadcrumb" id="breadcrumb">
                        <!-- Breadcrumb navigation -->
                    </div>
                    
                    <div class="gallery-grid" id="galleryGrid">
                        <!-- Images and folders will be loaded here -->
                    </div>
                    
                    <div class="gallery-empty" id="galleryEmpty">
                        <p>No items in this folder</p>
                    </div>
                    </div>
                </section>

                <!-- Reveal Browser Tab -->
                <section class="tab-content" id="revealTab">
                    <div class="gallery-panel">
                        <div class="gallery-header">
                            <h2>Reveal Browser</h2>
                            <div class="gallery-toolbar">
                                <button class="btn btn-sm" id="revealRefreshBtn" title="Refresh">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="23 4 23 10 17 10"></polyline>
                                        <polyline points="1 20 1 14 7 14"></polyline>
                                        <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10M1 14l5.36 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    <span>Refresh</span>
                                </button>
                                <button class="btn btn-sm" id="revealToggleViewBtn" title="Toggle Input/Output">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    <span>Show Output</span>
                                </button>
                            </div>
                        </div>

                        <div class="breadcrumb" id="revealBreadcrumb"></div>

                        <div class="gallery-grid" id="revealGrid"></div>
                        <div class="gallery-empty" id="revealEmpty"><p>No processed folders found</p></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Image Detail Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-overlay" id="imageOverlay"></div>
        <div class="modal-content image-detail-content">
            <button class="modal-close" id="closeImageBtn">×</button>
            
            <div class="image-detail">
                <button class="image-nav prev" id="imagePrev">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                
                <div class="image-detail-center">
                    <img id="detailImage" alt="Generated Image">
                    <span class="image-counter" id="imageCounter">0 / 0</span>
                    <div class="image-actions">
                        <button class="btn btn-primary import-btn" id="importBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Import to Form
                        </button>
                        <button class="btn btn-secondary" id="fullscreenBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                            </svg>
                            Fullscreen
                        </button>
                        <button class="btn btn-danger" id="deleteImageBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Delete Image
                        </button>
                    </div>
                    <div class="image-metadata" id="imageMetadata">
                        <!-- Metadata will be displayed here -->
                    </div>
                </div>
                
                <button class="image-nav next" id="imageNext">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div class="custom-modal" id="customDialog" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content">
            <h3 id="dialogTitle"></h3>
            <div id="dialogMessage"></div>
            <div id="dialogInput" style="display: none;">
                <input type="text" id="dialogInputField" class="form-control" placeholder="">
            </div>
            <div class="custom-modal-actions">
                <button class="btn btn-secondary" id="dialogCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="dialogConfirmBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="custom-modal" id="customAlert" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content">
            <h3 id="alertTitle">Notice</h3>
            <div id="alertMessage"></div>
            <div class="custom-modal-actions">
                <button class="btn btn-primary" id="alertOkBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Image Viewer -->
    <div class="fullscreen-viewer" id="fullscreenViewer">
        <div class="fullscreen-controls" id="fullscreenControls">
            <div class="fullscreen-counter" id="fullscreenCounter">0 / 0</div>
            
            <!-- Zoom Controls -->
            <div class="fullscreen-zoom-controls">
                <button class="fullscreen-control-btn" id="fullscreenZoomOut" title="Zoom Out (-)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </button>
                <span class="fullscreen-zoom-level" id="fullscreenZoomLevel">100%</span>
                <button class="fullscreen-control-btn" id="fullscreenZoomIn" title="Zoom In (+)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        <line x1="11" y1="8" x2="11" y2="14"></line>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </button>
                <button class="fullscreen-control-btn" id="fullscreenZoomReset" title="Reset Zoom (0)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                </button>
                <!-- Reveal Toggle (only active in Reveal mode) -->
                <button class="fullscreen-control-btn" id="fullscreenRevealToggle" title="Show Output" style="display: none;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
            </div>
            
            <!-- Autoplay Controls -->
            <div class="fullscreen-autoplay-controls">
                <button class="fullscreen-control-btn" id="fullscreenPlayPause" title="Play/Pause (Space)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="play-icon">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="pause-icon" style="display: none;">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                </button>
                <input type="number" id="fullscreenAutoplayInterval" class="fullscreen-interval-input" value="3" min="1" max="60" step="0.5" title="Autoplay interval (seconds)">
                <span style="color: white; font-size: 0.9rem;">s</span>
            </div>
            
            <button class="fullscreen-close" id="fullscreenClose">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <button class="fullscreen-nav fullscreen-prev" id="fullscreenPrev">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <button class="fullscreen-nav fullscreen-next" id="fullscreenNext">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>
        <div class="fullscreen-image-container" id="fullscreenImageContainer">
            <img id="fullscreenImage" alt="Fullscreen Image">
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- AI Edit Modal -->
    <div class="custom-modal" id="aiEditModal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h3>✨ AI Prompt Editor</h3>
            
            <!-- Model Selection -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="aiProvider">AI Provider</label>
                <select id="aiProvider" class="form-control" style="margin-bottom: 0.5rem;">
                    <option value="ollama">Ollama (Local)</option>
                    <option value="gemini">Google Gemini</option>
                </select>
                
                <label for="aiModel">Model</label>
                <select id="aiModel" class="form-control">
                    <option value="">Loading models...</option>
                </select>
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    <span id="modelInfo">Select a provider to load models</span>
                </small>
            </div>
            
            <!-- Current Prompt -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="aiCurrentPrompt">Starting Prompt (Editable)</label>
                <textarea 
                    id="aiCurrentPrompt" 
                    rows="4" 
                    class="form-control"
                    placeholder="Your prompt will appear here..."
                ></textarea>
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    Edit this prompt before optimizing or applying suggestions
                </small>
            </div>
            
            <!-- Action Buttons -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                    <button class="btn btn-primary" id="aiOptimizeBtn" style="flex: 1;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Optimize Prompt
                    </button>
                    <button class="btn btn-danger" id="aiStopBtn" style="display: none;" title="Stop generation and unload model">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="6" width="12" height="12"></rect>
                        </svg>
                    </button>
                    <button class="btn btn-secondary" id="aiCopyOptimizeInstructionsBtn" title="Copy optimize instructions to clipboard">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                    <button class="btn btn-secondary" id="aiCopyPromptBtn" title="Copy current prompt to clipboard">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
                <label class="checkbox-label" style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="aiUseOptimizeInstructions" class="checkbox-input" checked>
                    <span>Use default optimize instructions</span>
                </label>
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    When unchecked, only your starting prompt will be sent to the AI
                </small>
            </div>
            
            <!-- Suggestion Input -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <label for="aiSuggestion">Custom Suggestion (optional)</label>
                    <button class="btn btn-primary" id="aiApplySuggestionBtn" style="padding: 0.25rem 0.75rem; font-size: 0.9rem;">
                        Apply
                    </button>
                </div>
                <textarea 
                    id="aiSuggestion" 
                    rows="3" 
                    class="form-control" 
                    placeholder="e.g., make it more dramatic, add sunset lighting, change the mood to mysterious..."
                ></textarea>
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    Enter specific changes you want to make to the prompt
                </small>
            </div>
            
            <!-- Result Area -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="aiResult">AI Result</label>
                <textarea 
                    id="aiResult" 
                    rows="6" 
                    class="form-control"
                    placeholder="AI-generated prompt will appear here..."
                ></textarea>
                <div id="aiLoadingIndicator" style="display: none; margin-top: 0.5rem; color: var(--primary);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; display: inline-block;">
                        <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
                        <path d="M12 2 A10 10 0 0 1 22 12" stroke-opacity="0.75"></path>
                    </svg>
                    <span style="margin-left: 0.5rem;">AI is thinking...</span>
                </div>
            </div>
            
            <!-- Modal Actions -->
            <div class="custom-modal-actions">
                <button class="btn btn-secondary" id="aiModalCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="aiModalUseBtn">Use This Prompt</button>
            </div>
        </div>
    </div>

    <!-- AI Parameter Generator Modal -->
    <div class="custom-modal" id="aiParameterModal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h3>🤖 AI Parameter Generator</h3>
            
            <!-- Model Selection -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="aiParamProvider">AI Provider</label>
                <select id="aiParamProvider" class="form-control" style="margin-bottom: 0.5rem;">
                    <option value="ollama">Ollama (Local)</option>
                    <option value="gemini">Google Gemini</option>
                </select>
                
                <label for="aiParamModel">Model</label>
                <select id="aiParamModel" class="form-control">
                    <option value="">Loading models...</option>
                </select>
            </div>
            
            <!-- Count -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="aiParamCount">Number of Variations</label>
                <input 
                    type="number" 
                    id="aiParamCount" 
                    value="5" 
                    min="1" 
                    max="50"
                    class="form-control"
                >
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    Generate 1-50 parameter variations
                </small>
            </div>
            
            <!-- Context Options (Checkboxes) -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label>Include in AI Request</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label class="checkbox-label" style="cursor: pointer;">
                        <input type="checkbox" id="aiParamIncludeBasePrompt" class="checkbox-input" checked>
                        <span>Base Prompt Template</span>
                    </label>
                    <label class="checkbox-label" style="cursor: pointer;">
                        <input type="checkbox" id="aiParamIncludeInstructions" class="checkbox-input" checked>
                        <span>Default Instructions</span>
                    </label>
                    <label class="checkbox-label" style="cursor: pointer;">
                        <input type="checkbox" id="aiParamIncludeCustom" class="checkbox-input">
                        <span>Custom Suggestions (below)</span>
                    </label>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    Choose what information to send to the AI for CSV generation
                </small>
            </div>
            
            <!-- Custom Suggestions -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="aiParamContext">Custom Suggestions</label>
                <textarea 
                    id="aiParamContext" 
                    rows="4" 
                    class="form-control"
                    placeholder="e.g., Focus on fantasy themes, Use vibrant colors, Include various times of day, Add different age ranges..."
                ></textarea>
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    Add specific requirements or themes for parameter generation (enabled with checkbox above)
                </small>
            </div>
            
            <!-- Generate Button -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-primary btn-large" id="aiGenerateParamsBtn" style="flex: 1;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Generate Parameters
                </button>
                <button class="btn btn-danger" id="aiParamStopBtn" style="display: none;" title="Stop generation and unload model">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="6" width="12" height="12"></rect>
                    </svg>
                </button>
            </div>
            
            <!-- Result Area -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="aiParamResult">Generated CSV Data</label>
                <textarea 
                    id="aiParamResult" 
                    rows="10" 
                    class="form-control"
                    placeholder="Generated CSV data will appear here..."
                    style="font-family: monospace; font-size: 0.9rem;"
                ></textarea>
                <div id="aiParamLoadingIndicator" style="display: none; margin-top: 0.5rem; color: var(--primary);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; display: inline-block;">
                        <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
                        <path d="M12 2 A10 10 0 0 1 22 12" stroke-opacity="0.75"></path>
                    </svg>
                    <span style="margin-left: 0.5rem;">AI is generating parameters...</span>
                </div>
            </div>
            
            <!-- Modal Actions -->
            <div class="custom-modal-actions">
                <button class="btn btn-secondary" id="aiParamModalCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="aiParamModalUseBtn">Use This Data</button>
            </div>
        </div>
    </div>

    <!-- Per-Parameter Value Editor Modal -->
    <div class="custom-modal" id="parameterEditModal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h3>🎯 Edit Parameter Values</h3>
            
            <!-- Parameter Selection -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="editParamSelect">Select Parameters to Edit</label>
                <select id="editParamSelect" class="form-control" multiple size="8">
                    <option value="">-- No parameters available --</option>
                </select>
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    Select one or more parameters to generate values for. Hold Ctrl/Cmd to select multiple.
                </small>
            </div>
            
            <!-- Model Selection -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="editParamProvider">AI Provider</label>
                <select id="editParamProvider" class="form-control" style="margin-bottom: 0.5rem;">
                    <option value="ollama">Ollama (Local)</option>
                    <option value="gemini">Google Gemini</option>
                </select>
                
                <label for="editParamModel">Model</label>
                <select id="editParamModel" class="form-control">
                    <option value="">Loading models...</option>
                </select>
            </div>
            
            <!-- Count -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="editParamCount">Number of Values</label>
                <input 
                    type="number" 
                    id="editParamCount" 
                    value="5" 
                    min="1" 
                    max="50"
                    class="form-control"
                >
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    Generate 1-50 values for the selected parameter
                </small>
            </div>
            
            <!-- Custom Instructions -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="editParamInstructions">Instructions for AI</label>
                <textarea 
                    id="editParamInstructions" 
                    rows="4" 
                    class="form-control"
                    placeholder="e.g., Generate fantasy character names, Use vibrant color names, Create descriptive locations..."
                ></textarea>
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    Provide specific guidance for what kind of values to generate
                </small>
            </div>
            
            <!-- Generate Button -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-primary btn-large" id="editParamGenerateBtn" style="flex: 1;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Generate Values
                </button>
                <button class="btn btn-danger" id="editParamStopBtn" style="display: none;" title="Stop generation and unload model">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="6" width="12" height="12"></rect>
                    </svg>
                </button>
            </div>
            
            <!-- Result Area -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="editParamResult">Generated Values</label>
                <textarea 
                    id="editParamResult" 
                    rows="10" 
                    class="form-control"
                    placeholder="Generated values will appear here (one per line)..."
                    style="font-family: monospace; font-size: 0.9rem;"
                ></textarea>
                <div id="editParamLoadingIndicator" style="display: none; margin-top: 0.5rem; color: var(--primary);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; display: inline-block;">
                        <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
                        <path d="M12 2 A10 10 0 0 1 22 12" stroke-opacity="0.75"></path>
                    </svg>
                    <span style="margin-left: 0.5rem;">AI is generating values...</span>
                </div>
            </div>
            
            <!-- Modal Actions -->
            <div class="custom-modal-actions">
                <button class="btn btn-secondary" id="editParamModalCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="editParamModalApplyBtn">Apply to CSV</button>
            </div>
        </div>
    </div>

    <!-- Image Browser Modal -->
    <div class="custom-modal" id="imageBrowserModal" style="display: none;">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-content" style="max-width: 900px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <h3>Browse Images</h3>
            
            <!-- Folder Tabs -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                <button class="btn btn-sm image-browser-tab active" data-folder="input">Input Folder</button>
                <button class="btn btn-sm image-browser-tab" data-folder="output">Output Folder</button>
            </div>
            
            <!-- Current Path -->
            <div id="imageBrowserPath" style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                <span id="imageBrowserPathText">Loading...</span>
            </div>
            
            <!-- Image Grid -->
            <div id="imageBrowserGrid" style="flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
                <div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 2rem;">
                    Loading images...
                </div>
            </div>
            
            <!-- Modal Actions -->
            <div class="custom-modal-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" id="closeBrowserBtn">Cancel</button>
                <button class="btn btn-primary" id="useThisFolderBtn" style="display: none;">Use This Folder</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
